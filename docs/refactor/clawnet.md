---
summary: "Clawnet refactor: unify network protocol, roles, auth, approvals, identity"
read_when:
  - Planning a unified network protocol for nodes + operator clients
  - Reworking approvals, pairing, TLS, and presence across devices
---

# Clawnet 重构（协议 + 认证统一）

## 你好
你好 Peter — 这是一个很好的方向；这将解锁更简单的用户体验 + 更强的安全性。

## 目的
一份统一、严谨的文档，涵盖以下内容：
- 当前状态：协议、流程、信任边界。
- 痛点：审批流程、多跳路由、UI 重复。
- 提议的新状态：一个协议、作用域角色、统一的认证/配对、TLS 指纹绑定。
- 身份模型：稳定 ID + 有趣的别名。
- 迁移计划、风险、待解决问题。

## 目标（讨论中确定）
- 所有客户端（mac 应用、CLI、iOS、Android、无头节点）使用一个协议。
- 每个网络参与者都经过认证并完成配对。
- 角色清晰：节点 vs 操作员。
- 中心审批流程指向用户所在位置。
- 所有远程流量使用 TLS 加密 + 可选的指纹绑定。
- 最小化代码重复。
- 同一机器只能出现一次（没有 UI/节点的重复条目）。

## 非目标（明确说明）
- 移除能力隔离（仍然需要最小权限）。
- 在没有作用域检查的情况下暴露完整的网关控制平面。
- 使认证依赖于人类标签（别名不用于安全）。

---

# 当前状态（现状）

## 两种协议

### 1) 网关 WebSocket（控制平面）
- 完整的 API 表面：配置、通道、模型、会话、代理运行、日志、节点等。
- 默认绑定：回环地址。远程访问通过 SSH/Tailscale。
- 认证：通过 `connect` 使用 token/密码。
- 没有 TLS 指纹绑定（依赖回环/隧道）。
- 代码：
  - `src/gateway/server/ws-connection/message-handler.ts`
  - `src/gateway/client.ts`
  - `docs/gateway/protocol.md`

### 2) 桥接器（节点传输）
- 窄范围的允许列表表面，节点身份 + 配对。
- 通过 TCP 的 JSONL；可选 TLS + 证书指纹绑定。
- TLS 在发现 TXT 中通告指纹。
- 代码：
  - `src/infra/bridge/server/connection.ts`
  - `src/gateway/server-bridge.ts`
  - `src/node-host/bridge-client.ts`
  - `docs/gateway/bridge-protocol.md`

## 当前的控制平面客户端
- CLI → 通过 `callGateway` 连接到网关 WebSocket（`src/gateway/call.ts`）。
- macOS 应用 UI → 网关 WebSocket（`GatewayConnection`）。
- 网页控制 UI → 网关 WebSocket。
- ACP → 网关 WebSocket。
- 浏览器控制使用其自己的 HTTP 控制服务器。

## 当前的节点
- macOS 应用在节点模式下连接到网关桥接器（`MacNodeBridgeSession`）。
- iOS/Android 应用连接到网关桥接器。
- 配对信息 + 每节点的 token 存储在网关中。

## 当前的审批流程（执行）
- 代理通过网关使用 `system.run`。
- 网关通过桥接器调用节点。
- 节点运行时决定是否批准。
- 当节点 == macOS 应用时，由 macOS 应用显示 UI 提示。
- 节点返回 `invoke-res` 到网关。
- 多跳路由，UI 与节点主机绑定。

## 当前的在线状态 + 身份
- 网关的在线状态条目来自 WebSocket 客户端。
- 节点的在线状态条目来自桥接器。
- macOS 应用可能显示同一机器的两个条目（UI + 节点）。
- 节点身份存储在配对存储中；UI 身份是独立的。

- 两个协议栈需要维护（WS + Bridge）。
- 远程节点的审批：提示出现在节点主机上，而不是用户所在的位置。
- TLS 证书绑定仅存在于 Bridge；WS 依赖于 SSH/Tailscale。
- 身份重复：同一台机器显示为多个实例。
- 角色不明确：UI + 节点 + CLI 的功能未明确区分。

---

# 建议的新状态（Clawnet）

## 一种协议，两种角色
使用单一的 WS 协议，包含角色 + 范围。
- **角色：node**（能力主机）
- **角色：operator**（控制平面）
- 可选的 **范围** 用于 operator：
  - `operator.read`（状态 + 查看）
  - `operator.write`（执行代理，发送）
  - `operator.admin`（配置，通道，模型）

### 角色行为

**Node**
- 可以注册能力（`caps`, `commands`, 权限）。
- 可以接收 `invoke` 命令（`system.run`, `camera.*`, `canvas.*`, `screen.record` 等）。
- 可以发送事件：`voice.transcript`, `agent.request`, `chat.subscribe`。
- 不能调用控制平面 API（config/models/channels/sessions/agent 控制）。

**Operator**
- 完全控制平面 API，由范围控制。
- 接收所有审批。
- 不直接执行操作系统操作；将操作路由到节点。

### 关键规则
角色是基于连接的，而不是基于设备的。一个设备可以分别打开两种角色。

---

# 统一的身份认证 + 配对

## 客户端身份
每个客户端提供：
- `deviceId`（稳定，由设备密钥生成）。
- `displayName`（人类可读名称）。
- `role` + `scope` + `caps` + `commands`。

## 配对流程（统一）
- 客户端以未认证状态连接。
- 网关为该 `deviceId` 创建一个 **配对请求**。
- Operator 收到提示；进行审批/拒绝。
- 网关发放凭证，绑定到：
  - 设备公钥
  - 角色（role(s)）
  - 范围（scope(s)）
  - 能力/命令（capabilities/commands）
- 客户端保存令牌，重新连接时认证。

## 设备绑定认证（避免携带者令牌重放）
首选方案：设备密钥对。
- 设备生成一次密钥对。
- `deviceId = 公钥的指纹（fingerprint(publicKey)）`。
- 网关发送随机数（nonce）；设备签名；网关验证。
- 令牌发放给公钥（证明所有权），而不是字符串。

备选方案：
- mTLS（客户端证书）：最强，但操作复杂度更高。
- 仅在临时阶段使用短生命周期的携带者令牌（rotate + revoke 早期）。

## 静默审批（SSH 机制）
精确定义以避免成为弱点。优先选择以下之一：
- **仅本地**：当客户端通过 loopback/Unix socket 连接时，自动配对。
- **通过 SSH 的挑战**：网关发放随机数；客户端通过 SSH 证明身份。
- **物理存在窗口**：在网关主机 UI 上进行本地审批后，允许在短时间内（例如 10 分钟）自动配对。

始终记录并日志化自动审批。

## 应用于 WS
- WS 服务器支持使用相同的证书/密钥 + 指纹的 TLS。
- WS 客户端可以选择性地进行指纹固定（pinning）。
- 发现服务为所有端点广告 TLS + 指纹。
  - 发现服务仅提供定位提示；从不作为信任锚点。

## 原因
- 减少对 SSH/Tailscale 的机密性依赖。
- 默认使远程移动连接更安全。

---

# 审批机制重新设计（集中式）

## 当前情况
审批在节点主机（mac 应用的节点运行时）上进行。提示会在节点运行的位置出现。

## 提议方案
审批将由 **网关托管**，UI 将提供给操作员客户端。

### 新流程
1) 网关接收 `system.run` 意图（agent）。
2) 网关创建审批记录：`approval.requested`。
3) 操作员 UI 显示提示。
4) 审批决定发送到网关：`approval.resolve`。
5) 如果审批通过，网关调用节点命令。
6) 节点执行命令，返回 `invoke-res`。

### 审批语义（增强安全性）
- 广播给所有操作员；只有活动的 UI 显示模态框（其他操作员收到通知）。
- 第一个决议优先；网关将拒绝后续的决议，因为已解决。
- 默认超时时间：N 秒后拒绝（例如 60 秒），并记录原因。
- 决议需要 `operator.approvals` 范围权限。

## 优势
- 提示出现在用户所在的位置（mac/手机）。
- 为远程节点提供一致的审批体验。
- 节点运行时保持无头模式；不依赖 UI。

---

# 角色清晰度示例

## iPhone 应用
- **节点角色**：麦克风、摄像头、语音聊天、位置、按讲（push-to-talk）。
- 可选的 **operator.read**：用于状态和聊天视图。
- 可选的 **operator.write/admin**：仅在显式启用时可用。

## macOS 应用
- 默认为操作员角色（控制 UI）。
- 当启用“Mac 节点”时为节点角色（system.run, 屏幕, 摄像头）。
- 两种连接使用相同的 deviceId → 合并 UI 条目。

## CLI
- 永远为操作员角色。
- 范围由子命令推导：
  - `status`, `logs` → 读取
  - `agent`, `message` → 写入
  - `config`, `channels` → 管理员
  - 审批 + 配对 → `operator.approvals` / `operator.pairing`

---

# 身份 + 别名（slugs）

## 稳定 ID
用于认证，永不更改。
推荐使用：
- 密钥对指纹（公钥哈希）。

## 可爱别名（龙虾主题）
仅为人用标签。
- 例如：`scarlet-claw`, `saltwave`, `mantis-pinch`。
- 存储在网关注册表中，可编辑。
- 冲突处理：`-2`, `-3`。

## UI 分组
同一 `deviceId` 跨角色 → 单一“实例”行：
- 标签：`operator`, `node`。
- 显示功能 + 最后一次出现时间。

## 阶段5：弃用桥接
- 将iOS/Android/mac节点迁移至WS。
- 保留桥接作为备用方案；在稳定后移除。

## 阶段6：设备绑定认证
- 所有非本地连接必须要求基于密钥的身份验证。
- 添加撤销和轮换的用户界面。

---

# 安全说明

- 在网关边界强制执行角色/白名单。
- 无客户端在没有操作员作用域的情况下获得“完整”API。
- 所有连接都需要配对。
- TLS + 证书绑定可降低移动设备的中间人攻击风险。
- SSH静默批准是一种便利功能；但仍会被记录并可撤销。
- 发现机制永远不能作为信任锚点。
- 平台/类型会验证能力声明是否符合服务器白名单。

# 流媒体 + 大数据包（节点媒体）
WS控制平面适用于小消息，但节点还处理：
- 摄像头剪辑
- 屏幕录制
- 音频流

选项：
1) 使用WS二进制帧 + 分块 + 反压规则。
2) 添加单独的流媒体端点（仍使用TLS + 认证）。
3) 对于媒体密集型命令，延长保留桥接，最后再迁移。

在实现前选择一种方案以避免分歧。

# 能力 + 命令策略
- 节点报告的能力/命令被视为**声明**。
- 网关根据平台进行白名单控制。
- 任何新命令都需要操作员批准或明确的白名单更改。
- 审计更改并记录时间戳。

# 审计 + 限速
- 日志：配对请求、批准/拒绝、令牌发放/轮换/撤销。
- 限速配对垃圾信息和批准提示。

# 协议卫生
- 明确的协议版本 + 错误代码。
- 重连规则 + 心跳策略。
- 在线状态TTL和最后可见语义。

---

## 开放问题

1) 单一设备运行两个角色：令牌模型
   - 建议每个角色（节点 vs 操作员）使用独立的令牌。
   - 相同的 deviceId；不同的作用域；更清晰的撤销机制。

2) 操作员作用域的粒度
   - 读/写/管理 + 审批 + 配对（最低可行要求）。
   - 后续可考虑按功能划分的作用域。

3) 令牌轮换 + 撤销的用户体验
   - 在角色变更时自动轮换令牌。
   - 提供通过 deviceId + 角色撤销的用户界面。

4) 发现机制
   - 扩展当前的 Bonjour TXT 以包含 WS TLS 指纹 + 角色提示。
   - 仅作为定位提示处理。

5) 跨网络审批
   - 向所有操作员客户端广播；活跃的 UI 显示模态窗口。
   - 首个响应获胜；网关强制执行原子性。

---

## 总结（TL;DR）

- 今天：WS 控制平面 + 桥接节点传输。
- 痛点：审批流程 + 重复 + 两个协议栈。
- 提议：使用明确角色和作用域的单一 WS 协议，统一配对 + TLS 证书绑定，网关托管审批，稳定的设备 ID + 友好的标识符。
- 结果：更简洁的用户体验，更强的安全性，更少的重复，更好的移动路由。